name: Generate Voice from News

on:
  schedule:
    - cron: '5 21 * * *'
  workflow_dispatch:

jobs:
  generate-voice:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install gtts requests
    
    - name: Pull latest changes
      run: |
        git pull origin main || true
    
    - name: Create and run generator
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        GITHUB_USERNAME: ${{ github.repository_owner }}
        GITHUB_REPO: ${{ github.event.repository.name }}
      run: |
        cat > generate.py << 'PYEOF'
        import os
        from datetime import datetime, timedelta
        from gtts import gTTS
        import requests
        import base64

        GITHUB_USERNAME = os.environ['GITHUB_USERNAME']
        GITHUB_REPO = os.environ['GITHUB_REPO']
        GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
        DAYS_TO_KEEP = 7

        def fetch_news_text():
            today = (datetime.utcnow() + timedelta(hours=9)).strftime('%Y-%m-%d')
            url = f"https://api.github.com/repos/{GITHUB_USERNAME}/{GITHUB_REPO}/contents/{today}/news.txt"
            headers = {'Authorization': f'token {GITHUB_TOKEN}'}
            
            try:
                response = requests.get(url, headers=headers)
                if response.status_code == 200:
                    content = response.json()['content']
                    text = base64.b64decode(content).decode('utf-8')
                    print("„Éã„É•„Éº„Çπ„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæóÊàêÂäü")
                    return text, today
                else:
                    print(f"„Éã„É•„Éº„Çπ„ÉÜ„Ç≠„Çπ„ÉàÊú™ÂèñÂæó: {response.status_code}")
                    return None, today
            except Exception as e:
                print(f"„Ç®„É©„Éº: {e}")
                return None, today

        def create_speech_text(news_text):
            text = news_text.replace('===', '')
            text = text.replace('„Äê', '')
            text = text.replace('„Äë', '„ÄÇ')
            text = text.replace('‚Ä¢', '')
            text = text.replace(':', '„ÄÅ')
            speech_text = "‰ªäÊó•„ÅÆAI„Éã„É•„Éº„Çπ„Å®„ÅäÈáë„Å´„Å™„ÇãË©±„Çí„ÅäÂ±ä„Åë„Åó„Åæ„Åô„ÄÇ\n\n" + text
            return speech_text

        def generate_audio(text, filename):
            print(f"Èü≥Â£∞ÁîüÊàê‰∏≠: {filename}")
            tts = gTTS(text=text, lang='ja', slow=False)
            tts.save(filename)
            print("Èü≥Â£∞ÁîüÊàêÂÆå‰∫Ü")

        def create_html(news_text, date_str):
            html_news = news_text.replace('\n', '<br>')
            html_news = html_news.replace('===', '<h2>')
            html_news = html_news.replace('„Äê', '<h3>')
            html_news = html_news.replace('„Äë', '</h3>')
            
            now = datetime.utcnow() + timedelta(hours=9)
            time_str = now.strftime('%YÂπ¥%mÊúà%dÊó• %H:%M')
            
            # HTML„ÇíÊñáÂ≠óÂàóÈÄ£Áµê„Åß‰ΩúÊàêÔºàformat„Çí‰Ωø„Çè„Å™„ÅÑÔºâ
            html = '<!DOCTYPE html>\n'
            html += '<html lang="ja">\n'
            html += '<head>\n'
            html += '<meta charset="UTF-8">\n'
            html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n'
            html += '<title>‰ªäÊó•„ÅÆAI„Éã„É•„Éº„Çπ</title>\n'
            html += '<style>\n'
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }\n'
            html += 'body {\n'
            html += '  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n'
            html += '  line-height: 1.8;\n'
            html += '  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n'
            html += '  min-height: 100vh;\n'
            html += '  padding: 20px;\n'
            html += '}\n'
            html += '.container {\n'
            html += '  max-width: 800px;\n'
            html += '  margin: 0 auto;\n'
            html += '  background: white;\n'
            html += '  border-radius: 20px;\n'
            html += '  padding: 30px;\n'
            html += '  box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n'
            html += '}\n'
            html += 'h1 {\n'
            html += '  color: #333;\n'
            html += '  font-size: 28px;\n'
            html += '  margin-bottom: 10px;\n'
            html += '  border-bottom: 3px solid #667eea;\n'
            html += '  padding-bottom: 15px;\n'
            html += '}\n'
            html += '.date {\n'
            html += '  color: #666;\n'
            html += '  font-size: 14px;\n'
            html += '  margin-bottom: 20px;\n'
            html += '}\n'
            html += '.audio-controls {\n'
            html += '  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n'
            html += '  padding: 20px;\n'
            html += '  border-radius: 15px;\n'
            html += '  margin-bottom: 30px;\n'
            html += '}\n'
            html += '.play-button {\n'
            html += '  background: white;\n'
            html += '  color: #667eea;\n'
            html += '  border: none;\n'
            html += '  padding: 15px 30px;\n'
            html += '  font-size: 18px;\n'
            html += '  font-weight: bold;\n'
            html += '  border-radius: 50px;\n'
            html += '  cursor: pointer;\n'
            html += '  transition: all 0.3s;\n'
            html += '  display: flex;\n'
            html += '  align-items: center;\n'
            html += '  justify-content: center;\n'
            html += '  gap: 10px;\n'
            html += '  width: 100%;\n'
            html += '  margin-bottom: 15px;\n'
            html += '}\n'
            html += '.play-button:hover {\n'
            html += '  transform: scale(1.05);\n'
            html += '  box-shadow: 0 5px 15px rgba(0,0,0,0.3);\n'
            html += '}\n'
            html += '.download-button {\n'
            html += '  background: rgba(255,255,255,0.2);\n'
            html += '  color: white;\n'
            html += '  border: 2px solid white;\n'
            html += '  padding: 12px 25px;\n'
            html += '  font-size: 16px;\n'
            html += '  font-weight: bold;\n'
            html += '  border-radius: 50px;\n'
            html += '  cursor: pointer;\n'
            html += '  transition: all 0.3s;\n'
            html += '  display: flex;\n'
            html += '  align-items: center;\n'
            html += '  justify-content: center;\n'
            html += '  gap: 10px;\n'
            html += '  width: 100%;\n'
            html += '  text-decoration: none;\n'
            html += '}\n'
            html += '.download-button:hover {\n'
            html += '  background: white;\n'
            html += '  color: #667eea;\n'
            html += '}\n'
            html += '.controls {\n'
            html += '  display: flex;\n'
            html += '  gap: 10px;\n'
            html += '  align-items: center;\n'
            html += '  color: white;\n'
            html += '  margin-bottom: 15px;\n'
            html += '}\n'
            html += '.speed-control {\n'
            html += '  background: rgba(255,255,255,0.2);\n'
            html += '  border: 1px solid rgba(255,255,255,0.3);\n'
            html += '  color: white;\n'
            html += '  padding: 8px 15px;\n'
            html += '  border-radius: 20px;\n'
            html += '  font-size: 14px;\n'
            html += '}\n'
            html += '.content {\n'
            html += '  color: #333;\n'
            html += '  white-space: pre-wrap;\n'
            html += '}\n'
            html += '.content h2 {\n'
            html += '  color: #667eea;\n'
            html += '  font-size: 22px;\n'
            html += '  margin: 30px 0 15px 0;\n'
            html += '}\n'
            html += '.content h3 {\n'
            html += '  color: #333;\n'
            html += '  font-size: 18px;\n'
            html += '  margin: 20px 0 10px 0;\n'
            html += '}\n'
            html += '.footer {\n'
            html += '  text-align: center;\n'
            html += '  margin-top: 40px;\n'
            html += '  padding-top: 20px;\n'
            html += '  border-top: 1px solid #ddd;\n'
            html += '  color: #999;\n'
            html += '  font-size: 14px;\n'
            html += '}\n'
            html += '.status {\n'
            html += '  color: white;\n'
            html += '  font-size: 14px;\n'
            html += '  text-align: center;\n'
            html += '}\n'
            html += '</style>\n'
            html += '</head>\n'
            html += '<body>\n'
            html += '<div class="container">\n'
            html += '<h1>üì± ‰ªäÊó•„ÅÆAI„Éã„É•„Éº„Çπ</h1>\n'
            html += f'<div class="date">ÁîüÊàêÊó•ÊôÇ: {time_str}</div>\n'
            html += '\n'
            html += '<div class="audio-controls">\n'
            html += '  <button class="play-button" id="playBtn" onclick="toggleSpeech()">\n'
            html += '    <span id="playIcon">‚ñ∂Ô∏è</span>\n'
            html += '    <span id="playText">Èü≥Â£∞„ÅßËÅû„Åè(„Ç™„É≥„É©„Ç§„É≥)</span>\n'
            html += '  </button>\n'
            html += '  <a href="daily_news.mp3" download class="download-button">\n'
            html += '    <span>üì•</span>\n'
            html += '    <span>MP3„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ(„Ç™„Éï„É©„Ç§„É≥Áî®)</span>\n'
            html += '  </a>\n'
            html += '  <div class="controls">\n'
            html += '    <label for="speed">ÈÄüÂ∫¶:</label>\n'
            html += '    <select id="speed" class="speed-control" onchange="changeSpeed()">\n'
            html += '      <option value="0.75">0.75x</option>\n'
            html += '      <option value="1" selected>1x</option>\n'
            html += '      <option value="1.25">1.25x</option>\n'
            html += '      <option value="1.5">1.5x</option>\n'
            html += '    </select>\n'
            html += '  </div>\n'
            html += '  <div class="status" id="status">Ê∫ñÂÇôÂÆå‰∫Ü</div>\n'
            html += '</div>\n'
            html += '\n'
            html += '<div class="content" id="content">\n'
            html += html_news + '\n'
            html += '</div>\n'
            html += '\n'
            html += '<div class="footer">\n'
            html += 'Google Apps Script (ÂèéÈõÜ) + GitHub Actions (Èü≥Â£∞Âåñ)\n'
            html += '</div>\n'
            html += '</div>\n'
            html += '\n'
            html += '<script>\n'
            html += 'let synth = window.speechSynthesis;\n'
            html += 'let utterance = null;\n'
            html += 'let isPlaying = false;\n'
            html += '\n'
            html += 'function getTextContent() {\n'
            html += '  return document.getElementById("content").innerText;\n'
            html += '}\n'
            html += '\n'
            html += 'function toggleSpeech() {\n'
            html += '  if (isPlaying) {\n'
            html += '    synth.cancel();\n'
            html += '    isPlaying = false;\n'
            html += '    updateButton(false);\n'
            html += '    document.getElementById("status").textContent = "ÂÅúÊ≠¢";\n'
            html += '  } else {\n'
            html += '    const text = getTextContent();\n'
            html += '    utterance = new SpeechSynthesisUtterance(text);\n'
            html += '    utterance.lang = "ja-JP";\n'
            html += '    utterance.rate = parseFloat(document.getElementById("speed").value);\n'
            html += '    \n'
            html += '    utterance.onstart = () => {\n'
            html += '      isPlaying = true;\n'
            html += '      updateButton(true);\n'
            html += '      document.getElementById("status").textContent = "ÂÜçÁîü‰∏≠...";\n'
            html += '    };\n'
            html += '    \n'
            html += '    utterance.onend = () => {\n'
            html += '      isPlaying = false;\n'
            html += '      updateButton(false);\n'
            html += '      document.getElementById("status").textContent = "ÂÆå‰∫Ü";\n'
            html += '    };\n'
            html += '    \n'
            html += '    synth.speak(utterance);\n'
            html += '  }\n'
            html += '}\n'
            html += '\n'
            html += 'function changeSpeed() {\n'
            html += '  if (isPlaying) {\n'
            html += '    synth.cancel();\n'
            html += '    toggleSpeech();\n'
            html += '  }\n'
            html += '}\n'
            html += '\n'
            html += 'function updateButton(playing) {\n'
            html += '  const icon = document.getElementById("playIcon");\n'
            html += '  const text = document.getElementById("playText");\n'
            html += '  if (playing) {\n'
            html += '    icon.textContent = "‚è∏Ô∏è";\n'
            html += '    text.textContent = "ÂÅúÊ≠¢";\n'
            html += '  } else {\n'
            html += '    icon.textContent = "‚ñ∂Ô∏è";\n'
            html += '    text.textContent = "Èü≥Â£∞„ÅßËÅû„Åè(„Ç™„É≥„É©„Ç§„É≥)";\n'
            html += '  }\n'
            html += '}\n'
            html += '</script>\n'
            html += '</body>\n'
            html += '</html>\n'
            
            return html

        def upload_file(local_path, github_path):
            with open(local_path, 'rb') as f:
                content = base64.b64encode(f.read()).decode('utf-8')
            
            url = f"https://api.github.com/repos/{GITHUB_USERNAME}/{GITHUB_REPO}/contents/{github_path}"
            headers = {
                'Authorization': f'token {GITHUB_TOKEN}',
                'Content-Type': 'application/json'
            }
            
            response = requests.get(url, headers=headers)
            sha = response.json().get('sha') if response.status_code == 200 else None
            
            data = {'message': f'Update {github_path}', 'content': content}
            if sha:
                data['sha'] = sha
            
            response = requests.put(url, headers=headers, json=data)
            if response.status_code in [200, 201]:
                print(f"„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäü: {github_path}")
            else:
                print(f"„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó: {response.text}")

        def delete_old_folders():
            url = f"https://api.github.com/repos/{GITHUB_USERNAME}/{GITHUB_REPO}/contents/"
            headers = {'Authorization': f'token {GITHUB_TOKEN}'}
            
            response = requests.get(url, headers=headers)
            if response.status_code != 200:
                return
            
            items = response.json()
            today = datetime.utcnow()
            keep_date = today - timedelta(days=DAYS_TO_KEEP)
            
            for item in items:
                if item['type'] == 'dir' and len(item['name']) == 10:
                    try:
                        folder_date = datetime.strptime(item['name'], '%Y-%m-%d')
                        if folder_date < keep_date:
                            folder_url = f"{url}{item['name']}"
                            files_response = requests.get(folder_url, headers=headers)
                            if files_response.status_code == 200:
                                for file in files_response.json():
                                    delete_url = f"{folder_url}/{file['name']}"
                                    requests.delete(delete_url, headers=headers, json={
                                        'message': 'Delete old file',
                                        'sha': file['sha']
                                    })
                                print(f"ÂâäÈô§: {item['name']}")
                    except:
                        pass

        print("=== Èü≥Â£∞„ÉªHTMLÁîüÊàêÈñãÂßã ===")
        news_text, today = fetch_news_text()
        
        if news_text:
            speech_text = create_speech_text(news_text)
            generate_audio(speech_text, "daily_news.mp3")
            html_content = create_html(news_text, today)
            
            with open("index.html", "w", encoding="utf-8") as f:
                f.write(html_content)
            
            upload_file("index.html", f"{today}/index.html")
            upload_file("daily_news.mp3", f"{today}/daily_news.mp3")
            delete_old_folders()
            
            print(f"ÂÆå‰∫Ü! URL: https://{GITHUB_USERNAME}.github.io/{GITHUB_REPO}/{today}/")
        else:
            print("„Éã„É•„Éº„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì")
        PYEOF
        
        python generate.py
